<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESPrinkler2 Config</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Foundation CSS framework (Bootstrap and jQueryUI also supported) -->
    <link rel='stylesheet' href='/foundation.min.css'>
    <script src="/jsoneditor.min.js"></script>
    <script src="/jquery-3.2.1.min.js"></script>
    <style>
    .radius { border-radius: 3px; }
    .button { border-radius: 5px; }
    .callout { background-color: #ddd; }
    </style>
  	<script>
      // Set the default CSS theme and icon library globally
      JSONEditor.defaults.theme = 'foundation5';

      var editor;

  		function getConfig() {
        //console.log('get config');
        $.getJSON('config.json', function (data) {
          editor.setValue(data);
          //console.log(JSON.stringify(data));
        });
  		}
  		function saveConfig(data)
  		{
        $('#save, #save2').prop('disabled',true);
        var formData = new FormData();
        formData.append("data", new Blob([data], { type: "text/json" }), "/config.json");
        $.ajax({
          url: '/edit',
          data: formData,
          processData: false,
          contentType: false,
          type: 'POST'
        }).done(function () { $('#save, #save2').prop('disabled',false); });
  		}

      $(function () {
        $.ajaxSetup({ cache: false });
        editor = new JSONEditor($('#editor_holder')[0],{
          ajax: true,
          disable_collapse: true,
          disable_properties: true,
          required_by_default: true,
          remove_empty_properties: false,
          schema: {
            $ref: "config-schema.json"
          }
        });

        $('#save, #save2').click(function() {
          //console.log(JSON.stringify(editor.getValue()));
          saveConfig(JSON.stringify(editor.getValue()));
        });

        $('#load, #load2').click(function() {
          getConfig();
        });

        $( '#restart, #restart2').click(function(){
          $.get('restart', function(data) {
            alert(data);
          });
        });

        editor.on('ready',function() {
          $( "input[name='root[offsetGMT]']" ).after("<button id='settz'; class='tiny'>Set Timezone from Browser</button>");
          $( '#settz' ).click(function(){
            var offset = new Date().getTimezoneOffset() * -60;
            var d = editor.getValue();
            d.offsetGMT = offset;
            editor.setValue(d);
          })
          getConfig();
        });


      });

   </script>
 </head>
  <body>

    <div class="row">
      <div class="large-12 columns">
        <div class="panel">
          <h2>ESPrinkler2</h2>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="small-2 columns">
        <a href="/" class='button'>Go to Main Page</a>
      </div>
      <div class="small-2 columns">
        <a href="/edit.html" class='button'>Go to FS Editor</a>
      </div>
    </div>
    <div class='row'>
      <div class="small-12 columns">
          <button id='save' class='button tiny'>Save Config</button>
          <button id='load' class='button tiny'>Load Config</button>
          <button id='restart' class='button tiny'>Restart</button>
          <div id='editor_holder' class="panel callout radius"></div>
          <button id='save2' class='button tiny'>Save Config</button>
          <button id='load2' class='button tiny'>Load Config</button>
          <button id='restart2' class='button tiny'>Restart</button>
      </div>
    </div>

  </body>
</html>
